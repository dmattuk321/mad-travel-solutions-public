rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(uid()));
    }

    function role() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(uid()))
        ? userDoc().data.role
        : null;
    }

    function isAdmin() { return role() == "admin"; }
    function isDispatcher() { return role() == "dispatcher"; }
    function isDriver() { return role() == "driver"; }
    function isStaff() { return isAdmin() || isDispatcher(); }

    // ---------- USERS ----------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isStaff());
      allow create, update, delete: if signedIn() && isStaff();
    }

    // ---------- JOBS ----------
    match /jobs/{jobId} {

      // Staff can read all.
      // Drivers can read:
      //  - unassigned new jobs (available + tender listings)
      //  - jobs assigned to them (my jobs)
      allow read: if signedIn() && (
        isStaff()
        || (isDriver() && (
          (resource.data.status == "new" && resource.data.assignedDriverId == null)
          || (resource.data.assignedDriverId == uid())
        ))
      );

      allow create, delete: if signedIn() && isStaff();

      // Staff can update anything.
      // Drivers can:
      //  - accept set-price jobs that are new+unassigned
      //  - update status on their own assigned jobs
      allow update: if signedIn() && (
        isStaff()
        || driverAcceptingSetJob()
        || driverUpdatingOwnStatus()
      );

      function driverAcceptingSetJob() {
        return isDriver()
          && resource.data.status == "new"
          && resource.data.assignedDriverId == null
          && resource.data.jobType == "set"
          && request.resource.data.assignedDriverId == uid()
          && request.resource.data.status == "accepted";
      }

      function driverUpdatingOwnStatus() {
        return isDriver()
          && resource.data.assignedDriverId == uid()
          && request.resource.data.assignedDriverId == uid();
      }

      // ---------- BIDS (tender jobs) ----------
      match /bids/{bidId} {
        // Only staff can read all bids.
        // Drivers can read only their own bid doc.
        allow read: if signedIn() && (isStaff() || (isDriver() && bidId == uid()));

        // Drivers can create/update only their own bid doc,
        // and only while the job is still new+unassigned+tender.
        allow create, update: if signedIn()
          && isDriver()
          && bidId == uid()
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.jobType == "tender"
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.status == "new"
          && get(/databases/$(database)/documents/jobs/$(jobId)).data.assignedDriverId == null;

        // Only staff can delete bids (optional)
        allow delete: if signedIn() && isStaff();
      }
    }
  }
}
