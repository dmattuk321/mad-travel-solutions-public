rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function userPath() {
      return /databases/$(database)/documents/users/$(uid());
    }

    function role() {
      return signedIn() && exists(userPath())
        ? get(userPath()).data.role
        : null;
    }

    function isAdmin() {
      return role() == "admin";
    }

    function isDispatcher() {
      return role() == "dispatcher";
    }

    function isDriver() {
      return role() == "driver";
    }

    function isAdminOrDispatcher() {
      return isAdmin() || isDispatcher();
    }

    // ---------- USERS ----------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isAdminOrDispatcher());
      allow create, update, delete: if signedIn() && isAdminOrDispatcher();
    }

    // ---------- JOBS ----------
    match /jobs/{jobId} {

      // Any signed-in user can read jobs
      allow read: if signedIn();

      // Only admin/dispatcher can create jobs
      allow create: if signedIn() && isAdminOrDispatcher();

      // Delete jobs only admin/dispatcher
      allow delete: if signedIn() && isAdminOrDispatcher();

      // Updates allowed if:
      // - admin/dispatcher
      // - driver accepting an unassigned new job (fixed price jobs)
      // - driver updating status on their own job (forward-only)
      allow update: if signedIn() && (
        isAdminOrDispatcher()
        || driverAcceptingJob()
        || driverUpdatingOwnJobStatus()
      );

      function driverAcceptingJob() {
        return isDriver()
          && resource.data.status == "new"
          && resource.data.assignedDriverId == null
          && request.resource.data.assignedDriverId == uid()
          && request.resource.data.status == "accepted"
          // prevent driver changing core job details on accept
          && request.resource.data.jobId == resource.data.jobId
          && request.resource.data.pickupAddress == resource.data.pickupAddress
          && request.resource.data.dropoffAddress == resource.data.dropoffAddress
          && request.resource.data.pickupDate == resource.data.pickupDate
          && request.resource.data.pickupTime == resource.data.pickupTime
          && request.resource.data.price == resource.data.price;
      }

      function driverUpdatingOwnJobStatus() {
        return isDriver()
          && resource.data.assignedDriverId == uid()
          && request.resource.data.assignedDriverId == uid()
          && isValidForwardStatus(resource.data.status, request.resource.data.status);
      }

      function isValidForwardStatus(oldStatus, newStatus) {
        return
          (newStatus == oldStatus)
          ||
          (oldStatus == "accepted" && (
            newStatus == "started" ||
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "started" && (
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "arrived" && (
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "pob" && (
            newStatus == "completed"
          ));
      }

      // ---------- JOB BIDS (Tender) ----------
      // Stored under: /jobs/{jobId}/bids/{driverUid}
      match /bids/{bidId} {

        function parentJobPath() {
          return /databases/$(database)/documents/jobs/$(jobId);
        }

        function parentIsOpenForBids() {
          return exists(parentJobPath())
            && get(parentJobPath()).data.status == "new"
            && get(parentJobPath()).data.assignedDriverId == null;
        }

        // Admin/Dispatcher can read all bids
        // Driver can read ONLY their own bid
        allow read: if signedIn() && (
          isAdminOrDispatcher()
          || (isDriver() && bidId == uid())
        );

        // Driver can create/update ONLY their own bid document
        allow create, update: if signedIn()
          && isDriver()
          && parentIsOpenForBids()
          && bidId == uid()
          && request.resource.data.driverId == uid()
          && request.resource.data.price is number
          && request.resource.data.price > 0;

        allow delete: if false;
      }
    }
  }
}
