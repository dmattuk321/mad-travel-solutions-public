rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function userPath() {
      return /databases/$(database)/documents/users/$(uid());
    }

    function role() {
      return signedIn() && exists(userPath())
        ? get(userPath()).data.role
        : null;
    }

    function isAdmin() {
      return role() == "admin";
    }

    function isDispatcher() {
      return role() == "dispatcher";
    }

    function isDriver() {
      return role() == "driver";
    }

    function isAdminOrDispatcher() {
      return isAdmin() || isDispatcher();
    }

    // ---------- USERS ----------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isAdminOrDispatcher());
      allow create, update, delete: if signedIn() && isAdminOrDispatcher();
    }

    // ---------- JOBS ----------
    match /jobs/{jobId} {

      allow read: if signedIn();

      allow create: if signedIn() && isAdminOrDispatcher();

      allow delete: if signedIn() && isAdminOrDispatcher();

      allow update: if signedIn() && (
        isAdminOrDispatcher()
        || driverAcceptingFixedJob()
        || driverConfirmingAwardedTender()
        || driverUpdatingOwnJobStatus()
      );

      // --- Fixed price driver accept ---
      function driverAcceptingFixedJob() {
        return isDriver()
          && resource.data.pricingType == "fixed"
          && resource.data.status == "new"
          && resource.data.assignedDriverId == null
          && request.resource.data.assignedDriverId == uid()
          && request.resource.data.status == "accepted"
          // prevent driver changing core job details on accept
          && request.resource.data.pickupAddress == resource.data.pickupAddress
          && request.resource.data.dropoffAddress == resource.data.dropoffAddress
          && request.resource.data.pickupDate == resource.data.pickupDate
          && request.resource.data.pickupTime == resource.data.pickupTime
          && request.resource.data.price == resource.data.price
          && request.resource.data.pricingType == resource.data.pricingType;
      }

      // --- Tender winner confirm/decline within time window ---
      function driverConfirmingAwardedTender() {
        return isDriver()
          && resource.data.pricingType == "tender"
          && resource.data.status == "award_pending"
          && resource.data.assignedDriverId == uid()
          && request.resource.data.assignedDriverId == uid()
          && request.time < resource.data.awardExpiresAt
          && (
            request.resource.data.status == "accepted"
            || request.resource.data.status == "declined"
          )
          // prevent driver editing core job fields during confirm/decline
          && request.resource.data.pickupAddress == resource.data.pickupAddress
          && request.resource.data.dropoffAddress == resource.data.dropoffAddress
          && request.resource.data.pickupDate == resource.data.pickupDate
          && request.resource.data.pickupTime == resource.data.pickupTime
          && request.resource.data.pricingType == resource.data.pricingType;
      }

      // --- After accepted: driver can update only their own job status forward ---
      function driverUpdatingOwnJobStatus() {
        return isDriver()
          && resource.data.assignedDriverId == uid()
          && request.resource.data.assignedDriverId == uid()
          && isValidForwardStatus(resource.data.status, request.resource.data.status);
      }

      function isValidForwardStatus(oldStatus, newStatus) {
        return
          (newStatus == oldStatus)
          ||
          (oldStatus == "accepted" && (
            newStatus == "started" ||
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "started" && (
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "arrived" && (
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "pob" && (
            newStatus == "completed"
          ));
      }

      // ---------- JOB BIDS (Tender) ----------
      match /bids/{bidId} {

        function jobPath() {
          return /databases/$(database)/documents/jobs/$(jobId);
        }

        function parentIsOpenForBids() {
          return exists(jobPath())
            && get(jobPath()).data.pricingType == "tender"
            && get(jobPath()).data.status == "new"
            && get(jobPath()).data.assignedDriverId == null;
        }

        allow read: if signedIn() && (
          isAdminOrDispatcher()
          || (isDriver() && bidId == uid())
        );

        allow create, update: if signedIn()
          && isDriver()
          && parentIsOpenForBids()
          && bidId == uid()
          && request.resource.data.driverId == uid()
          && request.resource.data.price is number
          && request.resource.data.price > 0;

        allow delete: if false;
      }
    }
  }
}
