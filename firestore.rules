rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(uid()));
    }

    function role() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(uid()))
        ? userDoc().data.role
        : null;
    }

    function isAdmin() { return role() == "admin"; }
    function isDispatcher() { return role() == "dispatcher"; }
    function isDriver() { return role() == "driver"; }
    function isAdminOrDispatcher() { return isAdmin() || isDispatcher(); }

    // ---------- USERS ----------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isAdminOrDispatcher());
      allow create, update, delete: if signedIn() && isAdminOrDispatcher();
    }

    // ---------- JOBS ----------
    match /jobs/{jobId} {

      allow read: if signedIn();
      allow create: if signedIn() && isAdminOrDispatcher();
      allow delete: if signedIn() && isAdminOrDispatcher();

      allow update: if signedIn() && (
        isAdminOrDispatcher()
        || driverAcceptingFixedJob()
        || driverConfirmingOrDecliningOffer()
        || driverUpdatingOwnJobStatus()
      );

      // Fixed job accept (driver takes "new" unassigned fixed job)
      function driverAcceptingFixedJob() {
        return isDriver()
          && resource.data.status == "new"
          && resource.data.assignedDriverId == null
          && request.resource.data.assignedDriverId == uid()
          && request.resource.data.status == "accepted"
          && request.resource.data.pickupAddress == resource.data.pickupAddress
          && request.resource.data.dropoffAddress == resource.data.dropoffAddress
          && request.resource.data.pickupDate == resource.data.pickupDate
          && request.resource.data.pickupTime == resource.data.pickupTime
          && request.resource.data.price == resource.data.price
          && request.resource.data.pricingType == resource.data.pricingType;
      }

      // Tender offer confirm/decline (driver responds to "offer_pending")
      function driverConfirmingOrDecliningOffer() {
        return isDriver()
          && resource.data.status == "offer_pending"
          && resource.data.assignedDriverId == uid()
          && request.resource.data.pricingType == resource.data.pricingType
          // ACCEPT path
          && (
            (request.resource.data.status == "accepted"
              && request.resource.data.assignedDriverId == uid())
            ||
            // DECLINE path: reset job back to unassigned new
            (request.resource.data.status == "new"
              && request.resource.data.assignedDriverId == null)
          )
          // prevent driver editing job details while responding
          && request.resource.data.pickupAddress == resource.data.pickupAddress
          && request.resource.data.dropoffAddress == resource.data.dropoffAddress
          && request.resource.data.pickupDate == resource.data.pickupDate
          && request.resource.data.pickupTime == resource.data.pickupTime
          && request.resource.data.price == resource.data.price;
      }

      // Driver can update forward-only statuses AFTER accepted on their job
      function driverUpdatingOwnJobStatus() {
        return isDriver()
          && resource.data.assignedDriverId == uid()
          && request.resource.data.assignedDriverId == uid()
          && isValidForwardStatus(resource.data.status, request.resource.data.status);
      }

      function isValidForwardStatus(oldStatus, newStatus) {
        return
          (newStatus == oldStatus)
          ||
          (oldStatus == "accepted" && (
            newStatus == "started" ||
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "started" && (
            newStatus == "arrived" ||
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "arrived" && (
            newStatus == "pob" ||
            newStatus == "completed"
          ))
          ||
          (oldStatus == "pob" && ( newStatus == "completed" ));
      }

      // ---------- JOB BIDS (Tender) ----------
      match /bids/{bidId} {

        function parentJob() {
          return get(/databases/$(database)/documents/jobs/$(jobId));
        }

        function parentIsOpenForBids() {
          return exists(/databases/$(database)/documents/jobs/$(jobId))
            && parentJob().data.status == "new"
            && parentJob().data.assignedDriverId == null
            && parentJob().data.pricingType == "tender";
        }

        allow read: if signedIn() && (
          isAdminOrDispatcher()
          || (isDriver() && bidId == uid())
        );

        allow create, update: if signedIn()
          && isDriver()
          && parentIsOpenForBids()
          && bidId == uid()
          && request.resource.data.driverId == uid()
          && request.resource.data.price is number
          && request.resource.data.price > 0;

        allow delete: if false;
      }
    }
  }
}
